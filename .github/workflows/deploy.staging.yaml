---
name: Deploy code to stage
on:
  workflow_dispatch:
permissions:
  contents: read
jobs:
  build-frontend:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 20.3.x
          cache: npm
          cache-dependency-path: 'client/package-lock.json'

      - name: Initialize environment
        run: make -C client init

      - name: Build code
        run: make -C client build

      - name: Store dist artifact
        uses: actions/upload-artifact@master
        with:
          name: dist-frontend
          path: ${{ github.workspace }}/client/dist/

  build-backend:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/setup-go@v4
        with:
          go-version: "1.20.4"

      - name: Initialize environment
        run: make -C server init

      - name: Build binary
        run: make -C server build

      - name: Store build artifact
        uses: actions/upload-artifact@master
        with:
          name: dist-backend
          path: ${{ github.workspace }}/server/dist/

  deploy:
    runs-on: ubuntu-latest
    environment: staging
    needs: [build-frontend, build-backend]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download frontend
        uses: actions/download-artifact@v3
        with:
          name: dist-frontend
          path: client-dist/

      - name: Download backend
        uses: actions/download-artifact@v3
        with:
          name: dist-backend
          path: server-dist/

      - name: Test some stuf
        run: |
          ls
          echo ${{ github.workspace }}
          ls ${{ github.workspace }}

      - name: Copy Makefile to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "Makefile"
          target: /home/ec2-user/pagemail

      - name: Clean existing server resources
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd pagemail
            make pre-install

      - name: Copy frontend artifacts onto server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "client-dist/*"
          target: /home/ec2-user/pagemail/client/dist/
          strip_components: 1

      - name: Copy backend artifacts onto server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "server-dist/server"
          target: /home/ec2-user/pagemail/server/dist
          strip_components: 1

      - name: Copy nginx files onto server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "nginx/*,services/*"
          target: /home/ec2-user/pagemail

      - name: Run install scripts
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd pagemail
            make install-prod
            make install-nginx
            make post-install
